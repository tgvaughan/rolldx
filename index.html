<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="description" content="Simple dice roller.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    
    <title>Roll dX</title>


    <style>
     body {text-align: center;}

     button {font-size: 2em;}

     #roll-buttons {max-width: 100%;}

     #controls {
         margin-top: 1em;
         max-width: 100%;
     }

     #controls > button {
         padding-right: 1em;
         padding-left: 1em;
         margin-right: 1em;
     }

     #container {
         width: 100%;
         height: 10em;
         background: white;
         overflow-y: scroll;
         border: solid 1px black;
         resize: vertical;
     }

     #output {
         height: 100%;
         text-align: center;
         font-size: 2em;
         font-family: sans-serif;
     }

     .red-card {color: red;}
     .black-card {color: black;}
     .die-spec {font-weight: lighter; color: grey;}
    </style>

  </head>

  <body>
      <div id="container">
          <div id="output"></div>
      </div>

      <div id="roll-buttons">
          <button data-die="2">d2</button>
          <button data-die="4">d4</button>
          <button data-die="6">d6</button>
          <button data-die="8">d8</button>
          <button data-die="10">d10</button>
          <button data-die="12">d12</button>
          <button data-die="20">d20</button>
          <button data-die="100">d&percnt;</button>
          <button data-die="card">card</button>
      </div>

      <div id="controls">
          <button id="equals">=</button>
          <button id="clear">Clear</button>
          <input id="single-rolls" type="checkbox" checked="true">Single rolls</input>
      </div>
  </body>

  <script>
    /*
          @licstart  The following is the entire license notice for the
          JavaScript code in this page.

          Copyright (C) 2022  Tim Vaughan

          The JavaScript code in this page is free software: you can
          redistribute it and/or modify it under the terms of the GNU
          General Public License (GNU GPL) as published by the Free Software
          Foundation, either version 3 of the License, or (at your option)
          any later version.  The code is distributed WITHOUT ANY WARRANTY;
          without even the implied warranty of MERCHANTABILITY or FITNESS
          FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

          As additional permission under GNU GPL version 3 section 7, you
          may distribute non-source (e.g., minimized or compacted) forms of
          that code without the copy of the GNU GPL normally required by
          section 4, provided you include this license notice and a URL
          through which recipients can access the Corresponding Source.


          @licend  The above is the entire license notice
          for the JavaScript code in this page.
    */

    var current_sum = 0;

    const out = document.querySelector('#output');
    const container = document.querySelector('#container');
    const single_roll_checkbox = document.querySelector('#single-rolls');

    function roll_die(d) {
        var result, result_el;
        
        if (d == "card") {
            const card_idx = Math.floor(Math.random()*(52+2));

            if (card_idx >= 52) {
                result = 0;
                result_el = document.createTextNode(String.fromCodePoint(0x1f0cf));
            } else {
                result = card_idx % 13 + 1;
                const suit = Math.floor(card_idx / 13);

                result_el = document.createElement("span");
                result_string = ""
                if (result == 1)
                    result_string += "A"
                else if (result <= 10)
                    result_string += result
                else
                    result_string += "JQK"[result-11]

                result_string += "♥♦♣♠"[suit];
                result_el.appendChild(document.createTextNode(result_string));
                result_el.className = suit<2 ? "red-card" : "black-card";
            }
        } else {
            result = Math.ceil(Math.random()*(1.0*d));
            result_el = document.createElement("span");
            result_el.appendChild(document.createTextNode(result));
            result_el.appendChild(document.createElement("span"));
            result_el.lastChild.appendChild(document.createTextNode("[d" + d + "]"))
            result_el.lastChild.className = "die-spec";
        }

        return [result, result_el];
    }

    function roll(e) {
        if (e.target.tagName != "BUTTON")
                return false;

        const [result, result_el] = roll_die(e.target.dataset.die);

        if (!single_roll_checkbox.checked) {
            if (current_sum > 0)
                out.appendChild(document.createTextNode("+ "));

            current_sum += result;
        }

        out.appendChild(result_el);

        if (single_roll_checkbox.checked)
            out.appendChild(document.createElement("br"));
        else
            out.appendChild(document.createTextNode(" "));

        container.scrollTop = container.scrollHeight;
    }

    function clear() {
        current_sum = 0;
        out.replaceChildren();
    }

    function equals() {
        if (current_sum == 0)
            return false;

        out.appendChild(document.createTextNode("= " + current_sum));
        out.appendChild(document.createElement("br"));
        current_sum = 0;
    }

    function toggle_single_rolls() {
        if (single_roll_checkbox.checked)
            equals();
    }

    document.querySelector('#roll-buttons').addEventListener('click', roll);
    document.querySelector('#clear').addEventListener('click', clear);
    document.querySelector('#equals').addEventListener('click', equals);
    single_roll_checkbox.addEventListener('click', toggle_single_rolls);
  </script>
</html>
